Vue.config.devtools=!0;const civ_item={props:["match","steam_id","profile_id","steam_id_enemy","profile_id_enemy","civ_icon","player_type","index"],template:"#civ-item",data:()=>({player_index:-1,civ_icon_url:""}),computed:{left_px:function(){let e=0;return"player"==this.player_type?(e=10,0==this.index?left_px=e:left_px=e+30*this.index):"enemy"==this.player_type&&(e=380,0==this.index?left_px=e:left_px=e+30*this.index),left_px}},created(){"player"==this.player_type?this.player_index=this.match.players.findIndex(e=>e.steam_id==this.steam_id):this.steam_id_enemy?this.player_index=this.match.players.findIndex(e=>e.steam_id==this.steam_id_enemy):this.profile_id_enemy?this.player_index=this.match.players.findIndex(e=>e.profile_id==this.profile_id_enemy):"enemy"==this.player_type&&(this.steam_id_enemy?this.player_index=this.match.players.findIndex(e=>e.steam_id!=this.steam_id):this.player_index=this.match.players.findIndex(e=>e.profile_id!=this.profile_id)),-1!=this.player_index&&(this.civ_icon_url=this.civ_icon.replace("civ_id",this.match.players[this.player_index].civ)+"?cache=purge")}},app=new Vue({el:"#app",components:{"civ-item":civ_item},data:{site_settings:{site_name:"Offico score"},timeframe:Date.now(),settings:{steam_id:"76561198020969037",profile_id:"1404537",matches_count:"50",hours_minus:14,num_players:2,from_date:"",show_player_civs:"yes",show_enemy_civs:"yes",steam_id_enemy:"",profile_id_enemy:""},endpoints:{last_matches:"https://aoe2.net/api/player/matches?game=aoe2de",civ_icon:"https://aoe2.club/assets/images/civs/(civ_id).png"},last_matches:{player:[],enemy:[]},score:{wins:0,losses:0,missing:!1,elo_change:0},winrate:{percentage:"",number_of_games:0,steam_id_enemy:"",last_match_id:""},is_loading:!1,current_match:{active:!1,players:[]},periodic_check:{timer:!1,interval:3e4},civ_id:0,player_index:-1},computed:{last_matches_url:function(){return`${this.endpoints.last_matches}&steam_id=${this.settings.steam_id}&count=${this.settings.matches_count}`},last_matches_url_enemy:function(){return this.settings.steam_id_enemy?`${this.endpoints.last_matches}&steam_id=${this.settings.steam_id_enemy}&count=${this.settings.matches_count}`:`${this.endpoints.last_matches}&profile_id=${this.settings.profile_id_enemy}&count=${this.settings.matches_count}`}},created(){this.get_url_info(),this.change_hours(),"yes"==this.settings.show_enemy_civs?this.get_score().then(()=>{this.get_score("enemy").then(()=>{this.get_winrate()})}):this.get_score(),this.start_periodic_check()},methods:{get_url_info(){const e=new URL(window.location.href),t=new URLSearchParams(e.search),s=["steam_id","hours_minus","matches_count","num_players","from_date","show_player_civs","show_enemy_civs"];for(let e of s)t.has(e)&&(this.settings[e]=t.get(e))},change_hours(){if(this.settings.from_date){const e=this.settings.from_date.split("-"),t=e[0].split("."),s=e[1].split(":");let i=new Date(t);i.setHours(s[0]),i.setMinutes(s[1]),i=new Date(i).setMinutes(s[1]),this.timeframe=i}else this.timeframe=Date.now();let e=new Date(this.timeframe);const t=this.settings.hours_minus;e.setHours(e.getHours()-t),this.timeframe=Date.parse(e)},async get_last_matches(e="player"){let t;"player"==e?t=this.last_matches_url:"enemy"==e&&(t=this.last_matches_url_enemy);let s;try{s=await fetch(t),console.log(s.ok)}catch(e){return console.error(e),[]}const i=await s.json(),n=i.filter(e=>e.num_players==this.settings.num_players);return"player"==e?this.last_matches.player=n:"enemy"==e&&(this.last_matches.enemy=n),i},async get_score(e="player"){"enemy"!=e?await this.get_last_matches(e).then(e=>{if(e.length<1)return;this.reset_settings();let t=!1;for(let s=0;s<e.length;s++){const i=e[s],n=(i.started,1e3*i.finished),a=i.players;if(i.num_players==this.settings.num_players){if(!t){const e=a.findIndex(e=>e.steam_id!=this.settings.steam_id);this.settings.profile_id_enemy=a[e].profile_id,this.settings.steam_id_enemy=a[e].steam_id,t=!0}if(0!=n){if(!(n<this.timeframe))if(null!=a[0].won)for(let e=0;e<a.length;e++){const t=a[e];t.steam_id==this.settings.steam_id&&(this.score.elo_change+=t.rating_change,t.won?this.score.wins++:this.score.losses++)}else this.score.missing=!0}else this.current_match.active=!0,this.current_match.players=a}}}).then(()=>{this.is_loading=!1}):this.settings.steam_id_enemy||this.settings.profile_id_enemy?this.get_last_matches(e):this.last_matches.enemy=[]},async get_winrate(){if(!this.settings.profile_id_enemy)return void(this.winrate.number_of_games=0);if(this.winrate.profile_id_enemy==this.settings.profile_id_enemy)return;const e=this.settings.matches_count;this.settings.matches_count="1000";const t=await fetch(this.last_matches_url_enemy),s=await t.json();this.settings.matches_count=e;const i=s.filter(e=>e.num_players==this.settings.num_players);if(i.length<1)return void(this.winrate.number_of_games=0);let n=0,a=0;for(let e=0;e<i.length;e++){const t=i[e].players;if(null!=t[0].won)for(let e=0;e<t.length;e++){const s=t[e];s.steam_id==this.settings.steam_id&&(s.won?n++:a++)}else this.score.missing=!0}let _=n+a,h=n/_*100;Number.isInteger(h)||(h=h.toFixed(2)),this.winrate.percentage=h,this.winrate.number_of_games=_,this.winrate.steam_id_enemy=this.settings.steam_id_enemy,this.winrate.profile_id_enemy=this.settings.profile_id_enemy},reset_settings(){this.score.wins=0,this.score.losses=0,this.score.elo_change=0,this.score.missing=!1,this.current_match.active=!1},refresh_data(){this.is_loading||(this.is_loading=!0,this.change_hours(),"yes"==this.settings.show_enemy_civs?this.get_score().then(()=>{this.get_score("enemy").then(()=>{this.get_winrate()})}):this.get_score())},start_periodic_check(){this.periodic_check.timer||(this.periodic_check.timer=setInterval(()=>{this.refresh_data()},this.periodic_check.interval))},stop_periodic_check(){clearInterval(this.periodic_check.timer),this.periodic_check.timer=!1}}});