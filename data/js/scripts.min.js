const civ_item={props:["match","steam_id","steam_id_enemy","civ_icon","player_type","index"],template:"#civ-item",data:()=>({player_index:-1,civ_icon_url:""}),computed:{left_px:function(){let e=0;return"player"==this.player_type?(e=10,0==this.index?left_px=e:left_px=e+30*this.index):"enemy"==this.player_type&&(e=380,0==this.index?left_px=e:left_px=e+30*this.index),left_px}},created(){"player"==this.player_type?this.player_index=this.match.players.findIndex(e=>e.steam_id==this.steam_id):this.steam_id_enemy?this.player_index=this.match.players.findIndex(e=>e.steam_id==this.steam_id_enemy):"enemy"==this.player_type&&(this.player_index=this.match.players.findIndex(e=>e.steam_id!=this.steam_id)),-1!=this.player_index&&(this.civ_icon_url=this.civ_icon.replace("civ_id",this.match.players[this.player_index].civ)+"?cache=off")}},app=new Vue({el:"#app",components:{"civ-item":civ_item},data:{site_settings:{site_name:"Offico score"},timeframe:Date.now(),settings:{steam_id:"76561198020969037",matches_count:"50",hours_minus:14,num_players:2,from_date:"",show_player_civs:"yes",show_enemy_civs:"yes",steam_id_enemy:""},endpoints:{last_matches:"https://aoe2.net/api/player/matches?game=aoe2de",civ_icon:"https://aoe2.club/assets/images/civs/(civ_id).png"},last_matches:{player:[],enemy:[]},score:{wins:0,losses:0,missing:!1,elo_change:0},is_loading:!1,current_match:{active:!1,players:[]},periodic_check:{timer:!1,interval:6e4},civ_id:0,player_index:-1},computed:{last_matches_url:function(){return`${this.endpoints.last_matches}&steam_id=${this.settings.steam_id}&count=${this.settings.matches_count}`},last_matches_url_enemy:function(){return`${this.endpoints.last_matches}&steam_id=${this.settings.steam_id_enemy}&count=${this.settings.matches_count}`}},created(){this.get_url_info(),this.change_hours(),"yes"==this.settings.show_enemy_civs?this.get_score().then(()=>{this.get_score("enemy")}):this.get_score(),this.start_periodic_check()},methods:{get_url_info(){const e=new URL(window.location.href),t=new URLSearchParams(e.search),s=["steam_id","hours_minus","matches_count","num_players","from_date","show_player_civs","show_enemy_civs"];for(let e of s)t.has(e)&&(this.settings[e]=t.get(e))},change_hours(){if(this.settings.from_date){const e=this.settings.from_date.split("-"),t=e[0].split("."),s=e[1].split(":");let i=new Date(t);i.setHours(s[0]),i.setMinutes(s[1]),i=new Date(i).setMinutes(s[1]),this.timeframe=i}else this.timeframe=Date.now();let e=new Date(this.timeframe);const t=this.settings.hours_minus;e.setHours(e.getHours()-t),this.timeframe=Date.parse(e)},async get_last_matches(e="player"){let t;"player"==e?t=this.last_matches_url:"enemy"==e&&(t=this.last_matches_url_enemy);const s=await fetch(t),i=await s.json(),a=i.filter(e=>e.num_players==this.settings.num_players);return"player"==e?this.last_matches.player=a:"enemy"==e&&(this.last_matches.enemy=a),i},async get_score(e="player"){"enemy"!=e?await this.get_last_matches(e).then(e=>{if(e.length<1)return;this.reset_settings();let t=!1;for(let s=0;s<e.length;s++){const i=e[s],a=(i.started,1e3*i.finished),n=i.players;if(i.num_players==this.settings.num_players){if(!t){const e=n.findIndex(e=>e.steam_id!=this.settings.steam_id);this.settings.steam_id_enemy=n[e].steam_id,t=!0}if(0!=a){if(!(a<this.timeframe))if(null!=n[0].won)for(let e=0;e<n.length;e++){const t=n[e];t.steam_id==this.settings.steam_id&&(this.score.elo_change+=t.rating_change,t.won?this.score.wins++:this.score.losses++)}else this.score.missing=!0}else this.current_match.active=!0,this.current_match.players=n}}this.loading=!1}):this.get_last_matches(e)},reset_settings(){this.score.wins=0,this.score.losses=0,this.score.elo_change=0,this.score.missing=!1,this.current_match.active=!1},refresh_data(){this.loading||(this.loading=!0,this.change_hours(),"yes"==this.settings.show_enemy_civs?this.get_score().then(()=>{this.get_score("enemy")}):this.get_score())},start_periodic_check(){this.periodic_check.timer||(this.periodic_check.timer=setInterval(()=>{this.refresh_data()},this.periodic_check.interval))},stop_periodic_check(){clearInterval(this.periodic_check.timer),this.periodic_check.timer=!1}}});